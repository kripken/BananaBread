<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8" />
</head>
<body>
	<div id="sessions">
	</div>
</body>
<script>
	var brokerUrl = 'http://modeswit.ch:3000';
	if(window.location.search) {
	  var params = window.location.search.substring(1).split('&');
	  for(var i = 0; i < params.length; ++ i) {
	    if(params[i].match('^webrtc-broker')) {
	      brokerUrl = params[i].split('=')[1];
	    }
	  }
	}

	console.log(brokerUrl);

	var sessions = {};

	var listing = new EventSource(brokerUrl + '/list?application=bananabread');
	listing.addEventListener('list', function(event) {
		var data = JSON.parse(event.data);
		data.forEach(function(session) {
			var sid = session['sid'];
			sessions[sid] = session;
		});
		display(data);
	});
	listing.addEventListener('insert', function(event) {
		var data = JSON.parse(event.data);
		data.forEach(function(session) {
			var sid = session['sid'];
			sessions[sid] = session;
		});
		display(data);
	});
	listing.addEventListener('delete', function(event) {
		var data = JSON.parse(event.data);
		data.forEach(function(sid) {
			var session = sessions[sid];
			var element = session.element;
			console.log('removing', element);
			element.parentNode.removeChild(element);			
			delete sessions[sid];
		});
	});

	function display(sessions) {
		sessions = sessions || {};
		var sids = Object.keys(sessions);
		sids.forEach(function(sid) {
			var session = sessions[sid];
			var div = document.getElementById('sessions');
			var element = document.createElement('div');
			session.element = element;
			element.innerHTML = new Date(session['created']).toString() + '|' + session['application'] + '|' + '<a href="' + session['url'] + '">join</a>';
			div.appendChild(element);			
		});
	};
</script>
</html>